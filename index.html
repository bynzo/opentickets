<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Order Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #70bd95; /* Main background color */
        }
        /* Style for the scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e6e6e6;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #b3b3b3;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #8e8e8e;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and ReactDOM CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts for charts -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>

    <!-- Firebase SDKs - These are the specific versions for this project -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // This is the core application logic.
        (async function() {
            // =============================================================
            //  !!! IMPORTANT !!!
            //  REPLACE THE FOLLOWING WITH YOUR OWN FIREBASE CONFIGURATION
            //  You can find this in your Firebase project settings.
            // =============================================================
            const firebaseConfig = {
  apiKey: "AIzaSyAil9c2kq2C9jkPDGwlKtJj8qUd_oXqQzI",
  authDomain: "openticketdashboard.firebaseapp.com",
  projectId: "openticketdashboard",
  storageBucket: "openticketdashboard.firebasestorage.app",
  messagingSenderId: "745663706828",
  appId: "1:745663706828:web:068b44618714aa7a3f3469"
};

            const APP_ID = firebaseConfig.appId;

            // Initialize Firebase services
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            // Sign in anonymously to enable Firestore access.
            await signInAnonymously(auth).catch((error) => {
                console.error("Anonymous sign-in failed:", error);
            });

            // The main React application code
            // This is enclosed in a self-executing async function to keep it contained.
            const { useState, useEffect, createElement } = React;
            const { PieChart, Pie, Tooltip, Legend, LineChart, Line, ResponsiveContainer, Cell, XAxis, YAxis, CartesianGrid } = Recharts;

            // Predefined statuses and colors for consistency in charts and tables
            const predefinedStatuses = [
                'Completed',
                'In progress',
                'Scheduled',
                'Waiting for material',
                'Waiting for quote',
                'Waiting on client\'s approval',
                'Waiting H&S review',
                'Waiting for Invoice / PO',
                'Scope clarification needed',
            ];

            const statusColors = {
                'Completed': '#006400', // Dark Green
                'In progress': '#FFA500', // Orange
                'Scheduled': '#4169E1', // Royal Blue
                'Waiting for material': '#DC143C', // Crimson
                'Waiting for quote': '#8A2BE2', // Blue-Violet
                'Waiting on client\'s approval': '#FF69B4', // Hot Pink
                'Waiting H&S review': '#00CED1', // Dark Turquoise
                'Waiting for Invoice / PO': '#32CD32', // Lime Green
                'Scope clarification needed': '#696969', // Dim Gray
            };

            // Helper function to consolidate statuses for grouping
            const getConsolidatedStatus = (status) => {
                if (status && typeof status === 'string' && status.toLowerCase().startsWith('in progress')) {
                    return 'In progress';
                }
                return status;
            };
            
            // Helper function to parse dates
            const parseDate = (dateStr) => {
                if (typeof dateStr !== 'string' || !dateStr || !dateStr.includes('-')) {
                    return null;
                }
                const [year, month, day] = dateStr.split('-').map(Number);
                if (isNaN(year) || isNaN(month) || isNaN(day)) {
                    return null;
                }
                return new Date(year, month - 1, day);
            };

            // Calendar component to visualize planned tickets
            const CalendarView = ({ tickets }) => {
                const [currentMonth, setCurrentMonth] = useState(new Date());

                const plannedDates = tickets
                    .filter(t => t.plannedDate)
                    .map(t => ({ date: parseDate(t.plannedDate), status: getConsolidatedStatus(t.status) }));

                const getDaysInMonth = (date) => {
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    return new Date(year, month + 1, 0).getDate();
                };

                const getFirstDayOfMonth = (date) => {
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    return new Date(year, month, 1).getDay();
                };

                const handlePrevMonth = () => {
                    setCurrentMonth(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1));
                };

                const handleNextMonth = () => {
                    setCurrentMonth(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1));
                };

                const daysInMonth = getDaysInMonth(currentMonth);
                const firstDay = getFirstDayOfMonth(currentMonth);

                const days = [];
                for (let i = 0; i < firstDay; i++) {
                    days.push(createElement('div', { key: `empty-${i}`, className: 'p-2' }));
                }
                for (let i = 1; i <= daysInMonth; i++) {
                    const events = plannedDates.filter(e =>
                        e.date &&
                        e.date.getDate() === i &&
                        e.date.getMonth() === currentMonth.getMonth() &&
                        e.date.getFullYear() === currentMonth.getFullYear()
                    );
                    days.push(
                        createElement('div', {
                            key: i,
                            className: `p-2 border border-gray-300 rounded-lg text-sm transition-colors duration-200 ${events.length > 0 ? 'bg-[#cce5d9] hover:bg-[#b8d1c1]' : 'hover:bg-[#e6e6e6]'}`,
                            title: events.length > 0 ? events.map(e => `Status: ${e.status}`).join(', ') : ''
                        },
                            createElement('div', { className: 'font-bold text-[#00212d]' }, i),
                            events.length > 0 && (
                                createElement('div', { className: 'flex flex-wrap mt-1' },
                                    events.map((event, eventIndex) => (
                                        createElement('span', { key: eventIndex, className: 'w-2 h-2 rounded-full m-[1px]', style: { backgroundColor: statusColors[event.status] } })
                                    ))
                                )
                            )
                        )
                    );
                }

                return (
                    createElement('div', { className: 'bg-[#f2f2f2] p-6 rounded-2xl shadow-lg mt-8 text-[#00212d]' },
                        createElement('div', { className: 'flex justify-between items-center mb-4' },
                            createElement('button', { onClick: handlePrevMonth, className: 'text-[#00212d] hover:text-[#003366] font-semibold transition-colors duration-200' }, '< Prev'),
                            createElement('h2', { className: 'text-xl font-semibold text-center text-[#00212d]' }, currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' })),
                            createElement('button', { onClick: handleNextMonth, className: 'text-[#00212d] hover:text-[#003366] font-semibold transition-colors duration-200' }, 'Next >')
                        ),
                        createElement('div', { className: 'grid grid-cols-7 gap-1 text-center text-[#4a5568] text-sm mb-2' },
                            createElement('div', null, 'Sun'),
                            createElement('div', null, 'Mon'),
                            createElement('div', null, 'Tue'),
                            createElement('div', null, 'Wed'),
                            createElement('div', null, 'Thu'),
                            createElement('div', null, 'Fri'),
                            createElement('div', null, 'Sat')
                        ),
                        createElement('div', { className: 'grid grid-cols-7 gap-1 min-h-[300px]' }, days)
                    )
                );
            };

            // Modal to show detailed ticket information
            const TicketDetailsModal = ({ isOpen, onClose, ticket }) => {
                if (!isOpen || !ticket) return null;

                return (
                    createElement('div', { className: 'fixed inset-0 bg-[#00212d] bg-opacity-75 flex items-center justify-center p-4 z-50' },
                        createElement('div', { className: 'bg-[#f2f2f2] p-8 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto' },
                            createElement('div', { className: 'flex justify-between items-center mb-6' },
                                createElement('h2', { className: 'text-2xl font-bold text-[#003366]' }, `Ticket Details: ${ticket.workOrder}`),
                                createElement('button', { onClick: onClose, className: 'text-gray-500 hover:text-gray-800 text-3xl font-bold leading-none' }, 'Ã—')
                            ),
                            createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4 text-[#00212d] mb-6' },
                                createElement('div', null, createElement('strong', null, 'Description:'), ` ${ticket.description}`),
                                createElement('div', null, createElement('strong', null, 'Status:'), ` ${getConsolidatedStatus(ticket.status)}`),
                                createElement('div', null, createElement('strong', null, 'Submission Date:'), ` ${ticket.submissionDate}`),
                                createElement('div', null, createElement('strong', null, 'Planned Date:'), ` ${ticket.plannedDate || 'N/A'}`),
                                createElement('div', null, createElement('strong', null, 'Responsible:'), ` ${ticket.responsible || 'N/A'}`),
                                createElement('div', null, createElement('strong', null, 'High Risk:'), ` ${ticket.highRisk}`)
                            ),
                            ticket.image && (
                                createElement('div', { className: 'mt-4' },
                                    createElement('h3', { className: 'text-xl font-semibold text-[#003366] mb-3' }, 'Image'),
                                    createElement('img', { src: ticket.image, alt: `Image for ticket ${ticket.workOrder}`, className: 'w-full h-auto rounded-lg shadow-md max-h-96 object-contain' })
                                )
                            ),
                            createElement('div', { className: 'mt-4' },
                                createElement('h3', { className: 'text-xl font-semibold text-[#003366] mb-3' }, 'Comments'),
                                ticket.comments && ticket.comments.length > 0 ? (
                                    createElement('ul', { className: 'list-disc list-inside space-y-2 text-[#00212d]' },
                                        ticket.comments.map((comment, index) => (
                                            createElement('li', { key: index },
                                                createElement('span', { className: 'font-bold text-[#003366]' }, `${comment.date}:`), ` ${comment.text}`
                                            )
                                        ))
                                    )
                                ) : (
                                    createElement('p', { className: 'text-gray-500 italic' }, 'No comments available for this ticket.')
                                )
                            )
                        )
                    )
                );
            };

            // Main dashboard UI component
            const Dashboard = ({ tickets, onEdit, onDelete, onTicketClick, filterStatus, setFilterStatus, onAddTicket, userId }) => {
                const statusData = predefinedStatuses.map(status => {
                    const value = tickets.filter(t => getConsolidatedStatus(t.status) === status).length;
                    return { name: status, value, color: statusColors[status] };
                }).filter(s => s.value > 0);

                const handlePieClick = (data) => {
                    if (filterStatus === data.name) {
                        setFilterStatus('All');
                    } else {
                        setFilterStatus(data.name);
                    }
                };
                
                const [searchTerm, setSearchTerm] = useState('');
                const filteredTickets = tickets.filter(ticket => {
                    const matchesSearchTerm = Object.values(ticket).some(value =>
                        String(value).toLowerCase().includes(searchTerm.toLowerCase())
                    );
                    const matchesStatus = filterStatus === 'All' || getConsolidatedStatus(ticket.status) === filterStatus;
                    return matchesSearchTerm && matchesStatus;
                });

                const monthlyTicketCounts = filteredTickets.reduce((acc, ticket) => {
                    if (ticket.submissionDate) {
                        const date = new Date(ticket.submissionDate);
                        const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                        if (!acc[monthYear]) {
                            acc[monthYear] = 0;
                        }
                        acc[monthYear]++;
                    }
                    return acc;
                }, {});
                const evolutionData = Object.keys(monthlyTicketCounts).sort().map(monthYear => ({
                    name: monthYear,
                    count: monthlyTicketCounts[monthYear]
                }));
                
                return (
                    createElement('div', { className: 'bg-[#70bd95] text-[#00212d] min-h-screen p-8 font-sans' },
                        createElement('header', { className: 'bg-[#f2f2f2] p-4 rounded-2xl shadow-lg flex flex-col md:flex-row items-center justify-between mb-8' },
                            createElement('div', { className: 'flex items-center mb-4 md:mb-0' },
                                createElement('div', { className: 'flex-shrink-0' },
                                    createElement('img', { src: "https://placehold.co/40x40/f2f2f2/00212d?text=Logo", alt: "Company Logo", className: 'h-10 w-auto mr-4' })
                                ),
                                createElement('h1', { className: 'text-3xl font-bold text-[#00212d] text-center md:text-left' }, 'Work Order Dashboard')
                            ),
                            createElement('div', { className: 'flex-shrink-0 text-sm text-[#4a5568] text-center md:text-right' },
                                createElement('p', null, 'Current User ID:', createElement('span', { className: 'font-mono text-xs' }, userId || 'Loading...'))
                            )
                        ),
                        createElement('div', { className: 'flex justify-end mb-4' },
                            createElement('button', {
                                onClick: onAddTicket,
                                className: 'bg-[#003366] hover:bg-[#00212d] text-[#f2f2f2] font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-200'
                            }, '+ Add Ticket')
                        ),
                        createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-8 mb-12' },
                            createElement('div', { className: 'bg-[#f2f2f2] p-6 rounded-2xl shadow-lg flex flex-col items-center' },
                                createElement('h2', { className: 'text-xl font-semibold mb-4 text-center text-[#00212d]' }, 'Ticket Status'),
                                createElement(ResponsiveContainer, { width: '100%', height: 300 },
                                    createElement(PieChart, null,
                                        createElement(Pie, {
                                            data: statusData,
                                            dataKey: 'value',
                                            nameKey: 'name',
                                            cx: '50%',
                                            cy: '50%',
                                            outerRadius: 80,
                                            fill: '#8884d8',
                                            label: ({ value }) => value,
                                            onClick: handlePieClick
                                        },
                                            statusData.map((entry, index) => (
                                                createElement(Cell, { key: `cell-${index}`, fill: entry.color })
                                            ))
                                        ),
                                        createElement(Tooltip, { contentStyle: { backgroundColor: '#f2f2f2', borderColor: '#d3d3d3', color: '#00212d' } }),
                                        createElement(Legend, { layout: 'vertical', align: 'right', verticalAlign: 'middle' })
                                    )
                                )
                            ),
                            createElement('div', { className: 'bg-[#f2f2f2] p-6 rounded-2xl shadow-lg' },
                                createElement('h2', { className: 'text-xl font-semibold mb-4 text-center text-[#00212d]' }, 'Ticket Evolution'),
                                createElement(ResponsiveContainer, { width: '100%', height: 300 },
                                    createElement(LineChart, { data: evolutionData },
                                        createElement(CartesianGrid, { strokeDasharray: '3 3', stroke: '#ccc' }),
                                        createElement(XAxis, { dataKey: 'name', stroke: '#00212d' }),
                                        createElement(YAxis, { stroke: '#00212d' }),
                                        createElement(Tooltip, { contentStyle: { backgroundColor: '#f2f2f2', borderColor: '#d3d3d3', color: '#00212d' } }),
                                        createElement(Legend, null),
                                        createElement(Line, { type: 'monotone', dataKey: 'count', stroke: '#003366', activeDot: { r: 8 }, name: 'New Tickets' })
                                    )
                                )
                            )
                        ),
                        createElement(CalendarView, { tickets: filteredTickets }),
                        createElement('div', { className: 'bg-[#f2f2f2] p-6 rounded-2xl shadow-lg mt-8' },
                            createElement('h2', { className: 'text-2xl font-bold mb-6 text-center text-[#003366]' }, `Work Order Details (${filteredTickets.length} of ${tickets.length})`),
                            createElement('div', { className: 'flex flex-col md:flex-row justify-between mb-4 space-y-4 md:space-y-0' },
                                createElement('input', {
                                    type: 'text',
                                    placeholder: 'Search...',
                                    className: 'bg-white text-[#00212d] p-3 rounded-lg border border-gray-300 focus:outline-none focus:border-[#003366] w-full md:w-1/3',
                                    value: searchTerm,
                                    onChange: (e) => setSearchTerm(e.target.value)
                                }),
                                createElement('div', { className: 'flex items-center space-x-4' },
                                    filterStatus !== 'All' && (
                                        createElement('span', { className: 'text-sm font-medium text-[#4a5568]' },
                                            'Filtering by: ',
                                            createElement('span', { className: 'font-bold text-[#003366]' }, filterStatus)
                                        )
                                    ),
                                    createElement('button', {
                                        onClick: () => setFilterStatus('All'),
                                        className: 'bg-white hover:bg-gray-100 text-[#00212d] py-2 px-4 rounded-lg text-sm transition-colors duration-200 border border-gray-300'
                                    }, 'Clear Filter')
                                )
                            ),
                            createElement('div', { className: 'overflow-x-auto' },
                                createElement('table', { className: 'min-w-full divide-y divide-gray-300' },
                                    createElement('thead', { className: 'bg-[#e6e6e6]' },
                                        createElement('tr', null,
                                            createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider' }, 'Work Order'),
                                            createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider' }, 'Image'),
                                            createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider' }, 'Description'),
                                            createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider' }, 'Status'),
                                            createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider' }, 'Submission Date'),
                                            createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider' }, 'Planned Date'),
                                            createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider' }, 'Responsible'),
                                            createElement('th', { className: 'px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider' }, 'Actions')
                                        )
                                    ),
                                    createElement('tbody', { className: 'bg-[#f2f2f2] divide-y divide-gray-300' },
                                        filteredTickets.map(ticket => (
                                            createElement('tr', {
                                                key: ticket.id,
                                                className: 'hover:bg-gray-100 transition-colors duration-200 cursor-pointer',
                                                onClick: () => onTicketClick(ticket)
                                            },
                                                createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-[#00212d]' }, ticket.workOrder),
                                                createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-[#00212d]' },
                                                    ticket.image && (
                                                        createElement('img', {
                                                            src: ticket.image,
                                                            alt: 'Ticket thumbnail',
                                                            className: 'h-10 w-10 object-cover rounded-lg'
                                                        })
                                                    )
                                                ),
                                                createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-[#00212d]' }, ticket.description),
                                                createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-[#00212d]' }, getConsolidatedStatus(ticket.status)),
                                                createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-[#00212d]' }, ticket.submissionDate),
                                                createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-[#00212d]' }, ticket.plannedDate || 'N/A'),
                                                createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-[#00212d]' }, ticket.responsible || 'N/A'),
                                                createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium' },
                                                    createElement('button', {
                                                        onClick: (e) => { e.stopPropagation(); onEdit(ticket); },
                                                        className: 'text-[#003366] hover:text-[#00212d] transition-colors duration-200 mr-4'
                                                    }, 'Edit'),
                                                    createElement('button', {
                                                        onClick: (e) => { e.stopPropagation(); onDelete(ticket.id); },
                                                        className: 'text-red-600 hover:text-red-800 transition-colors duration-200'
                                                    }, 'Delete')
                                                )
                                            )
                                        ))
                                    )
                                )
                            )
                        )
                ));
                };

                const ConfirmationModal = ({ isOpen, message, onConfirm, onCancel }) => {
                    if (!isOpen) return null;

                    return (
                        createElement('div', { className: 'fixed inset-0 bg-[#00212d] bg-opacity-75 flex items-center justify-center p-4 z-50' },
                            createElement('div', { className: 'bg-[#f2f2f2] p-8 rounded-2xl shadow-xl max-w-sm w-full text-center' },
                                createElement('p', { className: 'text-lg text-[#00212d] mb-6' }, message),
                                createElement('div', { className: 'flex justify-center space-x-4' },
                                    createElement('button', {
                                        onClick: onConfirm,
                                        className: 'px-6 py-2 rounded-lg text-white bg-red-600 hover:bg-red-700 transition-colors duration-200 font-semibold'
                                    }, 'Confirm'),
                                    createElement('button', {
                                        onClick: onCancel,
                                        className: 'px-6 py-2 rounded-lg text-[#00212d] border border-gray-300 hover:bg-gray-100 transition-colors duration-200'
                                    }, 'Cancel')
                                )
                            )
                        )
                    );
                };

                const TicketFormModal = ({ isOpen, onClose, onSave, ticketToEdit }) => {
                    const initialFormState = {
                        id: null, workOrder: '', description: '', submissionDate: '', status: '', plannedDate: '',
                        responsible: '', highRisk: 'No', comments: [], image: null
                    };

                    const [form, setForm] = useState(initialFormState);
                    const [newComment, setNewComment] = useState('');

                    useEffect(() => {
                        if (ticketToEdit) {
                            setForm(ticketToEdit);
                        } else {
                            setForm(initialFormState);
                        }
                        setNewComment('');
                    }, [ticketToEdit, isOpen]);

                    const handleChange = (e) => {
                        const { name, value } = e.target;
                        setForm({ ...form, [name]: value });
                    };

                    const handleImageChange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onloadend = () => {
                                setForm({ ...form, image: reader.result });
                            };
                            reader.readAsDataURL(file);
                        }
                    };

                    const handleAddComment = () => {
                        if (newComment.trim() !== '') {
                            const today = new Date().toISOString().split('T')[0];
                            const updatedComments = [...form.comments, { date: today, text: newComment }];
                            setForm({ ...form, comments: updatedComments });
                            setNewComment('');
                        }
                    };

                    const handleSubmit = (e) => {
                        e.preventDefault();
                        onSave(form);
                        setForm(initialFormState);
                        onClose();
                    };

                    if (!isOpen) return null;

                    return (
                        createElement('div', { className: 'fixed inset-0 bg-[#00212d] bg-opacity-75 flex items-center justify-center p-4 z-50' },
                            createElement('div', { className: 'bg-[#f2f2f2] p-8 rounded-2xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto' },
                                createElement('h2', { className: 'text-2xl font-bold mb-6 text-center text-[#003366]' }, ticketToEdit ? 'Edit Ticket' : 'Add a New Ticket'),
                                createElement('form', { onSubmit: handleSubmit, className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },
                                    createElement('div', { className: 'flex flex-col' },
                                        createElement('label', { className: 'text-sm font-medium text-[#00212d] mb-1' }, 'Work Order'),
                                        createElement('input', { type: 'text', name: 'workOrder', value: form.workOrder, onChange: handleChange, className: 'p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]', required: true })
                                    ),
                                    createElement('div', { className: 'flex flex-col' },
                                        createElement('label', { className: 'text-sm font-medium text-[#00212d] mb-1' }, 'Description'),
                                        createElement('input', { type: 'text', name: 'description', value: form.description, onChange: handleChange, className: 'p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]', required: true })
                                    ),
                                    createElement('div', { className: 'flex flex-col' },
                                        createElement('label', { className: 'text-sm font-medium text-[#00212d] mb-1' }, 'Submission Date'),
                                        createElement('input', { type: 'date', name: 'submissionDate', value: form.submissionDate, onChange: handleChange, className: 'p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]' })
                                    ),
                                    createElement('div', { className: 'flex flex-col' },
                                        createElement('label', { className: 'text-sm font-medium text-[#00212d] mb-1' }, 'High Risk'),
                                        createElement('select', { name: 'highRisk', value: form.highRisk, onChange: handleChange, className: 'p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]' },
                                            createElement('option', { value: 'Yes' }, 'Yes'),
                                            createElement('option', { value: 'No' }, 'No')
                                        )
                                    ),
                                    createElement('div', { className: 'flex flex-col' },
                                        createElement('label', { className: 'text-sm font-medium text-[#00212d] mb-1' }, 'Status'),
                                        createElement('select', { name: 'status', value: form.status, onChange: handleChange, className: 'p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]', required: true },
                                            createElement('option', { value: '' }, 'Select a Status'),
                                            predefinedStatuses.map(status => (
                                                createElement('option', { key: status, value: status }, status)
                                            ))
                                        )
                                    ),
                                    createElement('div', { className: 'flex flex-col' },
                                        createElement('label', { className: 'text-sm font-medium text-[#00212d] mb-1' }, 'Planned Date'),
                                        createElement('input', { type: 'date', name: 'plannedDate', value: form.plannedDate || '', onChange: handleChange, className: 'p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]' })
                                    ),
                                    createElement('div', { className: 'flex flex-col' },
                                        createElement('label', { className: 'text-sm font-medium text-[#00212d] mb-1' }, 'Responsible'),
                                        createElement('input', { type: 'text', name: 'responsible', value: form.responsible, onChange: handleChange, className: 'p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]' })
                                    ),
                                    createElement('div', { className: 'flex flex-col' },
                                        createElement('label', { className: 'text-sm font-medium text-[#00212d] mb-1' }, 'Upload Image'),
                                        createElement('input', { type: 'file', onChange: handleImageChange, accept: 'image/*', className: 'p-2 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]' }),
                                        form.image && (
                                            createElement('div', { className: 'mt-2' },
                                                createElement('h4', { className: 'text-sm font-medium text-[#00212d]' }, 'Image Preview:'),
                                                createElement('img', { src: form.image, alt: 'ticket preview', className: 'w-24 h-24 object-cover rounded-lg mt-1' })
                                            )
                                        )
                                    ),
                                    createElement('div', { className: 'col-span-2' },
                                        createElement('label', { className: 'text-sm font-medium text-[#00212d] mb-2 block' }, 'Comments'),
                                        createElement('div', { className: 'bg-white p-4 rounded-lg border border-gray-300 mb-4 h-32 overflow-y-auto' },
                                            form.comments && form.comments.length > 0 ? (
                                                createElement('ul', { className: 'list-disc list-inside space-y-1' },
                                                    form.comments.map((comment, index) => (
                                                        createElement('li', { key: index, className: 'text-sm text-[#00212d]' },
                                                            createElement('span', { className: 'font-semibold' }, `${comment.date}:`), ` ${comment.text}`
                                                        )
                                                    ))
                                                )
                                            ) : (
                                                createElement('p', { className: 'text-sm text-gray-500 italic' }, 'No comments yet.')
                                            )
                                        ),
                                        createElement('div', { className: 'flex items-center space-x-2' },
                                            createElement('textarea', {
                                                value: newComment,
                                                onChange: (e) => setNewComment(e.target.value),
                                                placeholder: 'Add a new comment...',
                                                className: 'flex-1 p-2 rounded-lg border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]',
                                                rows: '2'
                                            }),
                                            createElement('button', {
                                                type: 'button',
                                                onClick: handleAddComment,
                                                className: 'bg-[#003366] hover:bg-[#00212d] text-[#f2f2f2] font-semibold py-2 px-4 rounded-lg transition-colors duration-200 h-full'
                                            }, 'Add')
                                        )
                                    ),
                                    createElement('div', { className: 'col-span-2 flex justify-end space-x-4 mt-4' },
                                        createElement('button', {
                                            type: 'button',
                                            onClick: onClose,
                                            className: 'px-6 py-3 rounded-lg text-[#00212d] border border-gray-300 hover:bg-gray-100 transition-colors duration-200'
                                        }, 'Cancel'),
                                        createElement('button', {
                                            type: 'submit',
                                            className: 'px-6 py-3 rounded-lg text-[#f2f2f2] bg-[#003366] hover:bg-[#00212d] font-semibold transition-colors duration-200'
                                        }, 'Save')
                                    )
                                )
                            )
                        )
                    );
                };

                // The main App component
                const App = () => {
                    const [tickets, setTickets] = useState([]);
                    const [isAuthReady, setIsAuthReady] = useState(false);
                    const [userId, setUserId] = useState(null);
                    const [isModalOpen, setIsModalOpen] = useState(false);
                    const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
                    const [ticketToDelete, setTicketToDelete] = useState(null);
                    const [ticketToEdit, setTicketToEdit] = useState(null);
                    const [selectedTicket, setSelectedTicket] = useState(null);
                    const [filterStatus, setFilterStatus] = useState('All');
                
                    // Firebase Auth listener
                    useEffect(() => {
                        const unsubscribe = onAuthStateChanged(auth, (user) => {
                            if (user) {
                                setUserId(user.uid);
                            } else {
                                setUserId(null);
                            }
                            setIsAuthReady(true);
                        });
                        return () => unsubscribe();
                    }, []);
                
                    // Firestore data listener
                    useEffect(() => {
                        if (isAuthReady && userId) {
                            const ticketsCollectionRef = collection(db, 'artifacts', APP_ID, 'users', userId, 'tickets');
                            
                            const unsubscribe = onSnapshot(ticketsCollectionRef, (snapshot) => {
                                const fetchedTickets = snapshot.docs.map(doc => ({
                                    id: doc.id,
                                    ...doc.data()
                                }));
                                setTickets(fetchedTickets);
                            }, (error) => {
                                console.error("Error fetching tickets: ", error);
                            });
                
                            return () => unsubscribe();
                        }
                    }, [isAuthReady, userId]);
                
                    // Function to save or update a ticket to Firestore
                    const handleSaveTicket = async (ticketData) => {
                        if (!userId) {
                            console.error("User not authenticated. Cannot save ticket.");
                            return;
                        }
                
                        try {
                            const consolidatedData = {
                                ...ticketData,
                                status: getConsolidatedStatus(ticketData.status),
                                comments: ticketData.comments.map(c => ({ date: c.date, text: c.text })),
                                timestamp: serverTimestamp()
                            };
                            
                            const ticketsCollectionRef = collection(db, 'artifacts', APP_ID, 'users', userId, 'tickets');
                
                            if (consolidatedData.id) {
                                const ticketDocRef = doc(ticketsCollectionRef, consolidatedData.id);
                                await setDoc(ticketDocRef, consolidatedData, { merge: true });
                            } else {
                                await addDoc(ticketsCollectionRef, consolidatedData);
                            }
                        } catch (error) {
                            console.error("Error saving ticket: ", error);
                        }
                    };
                
                    const handleEditTicket = (ticket) => {
                        setTicketToEdit(ticket);
                        setIsModalOpen(true);
                    };
                
                    const handleDeleteTicket = (id) => {
                        setTicketToDelete(id);
                        setIsConfirmModalOpen(true);
                    };
                
                    const handleConfirmDelete = async () => {
                        if (!userId || !ticketToDelete) {
                            console.error("User not authenticated or no ticket to delete.");
                            return;
                        }
                    
                        try {
                            const ticketDocRef = doc(db, 'artifacts', APP_ID, 'users', userId, 'tickets', ticketToDelete);
                            await deleteDoc(ticketDocRef);
                            setIsConfirmModalOpen(false);
                            setTicketToDelete(null);
                        } catch (error) {
                            console.error("Error deleting ticket: ", error);
                        }
                    };
                
                    const handleCancelDelete = () => {
                        setIsConfirmModalOpen(false);
                        setTicketToDelete(null);
                    };
                
                    return (
                        createElement('div', { className: 'bg-[#70bd95] min-h-screen text-[#00212d] font-sans' },
                            createElement(Dashboard, {
                                tickets: tickets,
                                onEdit: handleEditTicket,
                                onDelete: handleDeleteTicket,
                                onTicketClick: setSelectedTicket,
                                filterStatus: filterStatus,
                                setFilterStatus: setFilterStatus,
                                onAddTicket: () => { setTicketToEdit(null); setIsModalOpen(true); },
                                userId: userId
                            }),
                            createElement(TicketFormModal, {
                                isOpen: isModalOpen,
                                onClose: () => setIsModalOpen(false),
                                onSave: handleSaveTicket,
                                ticketToEdit: ticketToEdit
                            }),
                            createElement(ConfirmationModal, {
                                isOpen: isConfirmModalOpen,
                                message: "Are you sure you want to delete this ticket?",
                                onConfirm: handleConfirmDelete,
                                onCancel: handleCancelDelete
                            }),
                            createElement(TicketDetailsModal, {
                                isOpen: !!selectedTicket,
                                onClose: () => setSelectedTicket(null),
                                ticket: selectedTicket
                            })
                        )
                    );
                };
                
            ReactDOM.createRoot(document.getElementById('root')).render(createElement(App));
        })();
    </script>
</body>
</html>
