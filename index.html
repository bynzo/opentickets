<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Order Dashboard</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #70bd95; /* Main background color */
        }
        /* Style for the scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e6e6e6;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #b3b3b3;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #8e8e8e;
        }

        /* Basic modal backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body class="antialiased">
    <div id="root" class="min-h-screen p-8 font-sans text-[#00212d]">
        <!-- Dashboard will be rendered here by JavaScript -->
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================
        //  !!! IMPORTANT !!!
        //  Please add your Firebase configuration here.
        //  You can find this in your Firebase project settings.
        // ====================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAil9c2kq2C9jkPDGwlKtJj8qUd_oXqQzI",
            authDomain: "openticketdashboard.firebaseapp.com",
            projectId: "openticketdashboard",
            storageBucket: "openticketdashboard.firebasestorage.app",
            messagingSenderId: "745663706828",
            appId: "1:745663706828:web:068b44618714aa7a3f3469"
};
        const APP_ID = "YOUR_APP_ID"; // Also add your app id here

        // Global state variables
        let app, db, auth;
        let tickets = [];
        let userId = null;
        let isAuthReady = false;
        let isLoggedIn = false;
        let filterStatus = 'All';

        // Predefined statuses and colors for consistency
        const predefinedStatuses = [
            'Completed',
            'In progress',
            'Scheduled',
            'Waiting for material',
            'Waiting for quote',
            'Waiting on client\'s approval',
            'Waiting H&S review',
            'Waiting for Invoice / PO',
            'Scope clarification needed',
        ];

        const statusColors = {
            'Completed': '#006400',
            'In progress': '#FFA500',
            'Scheduled': '#4169E1',
            'Waiting for material': '#DC143C',
            'Waiting for quote': '#8A2BE2',
            'Waiting on client\'s approval': '#FF69B4',
            'Waiting H&S review': '#00CED1',
            'Waiting for Invoice / PO': '#32CD32',
            'Scope clarification needed': '#696969',
        };

        // Helper function to consolidate statuses for grouping
        const getConsolidatedStatus = (status) => {
            if (status && typeof status === 'string' && status.toLowerCase().startsWith('in progress')) {
                return 'In progress';
            }
            return status;
        };
        
        // Helper function to parse dates
        const parseDate = (dateStr) => {
            if (typeof dateStr !== 'string' || !dateStr || !dateStr.includes('-')) {
                return null;
            }
            const [year, month, day] = dateStr.split('-').map(Number);
            if (isNaN(year) || isNaN(month) || isNaN(day)) {
                return null;
            }
            return new Date(year, month - 1, day);
        };

        // --- UI Rendering Functions ---

        const renderDashboard = () => {
            const root = document.getElementById('root');
            if (!root) return;
            
            const filteredTickets = tickets.filter(ticket => {
                const matchesStatus = filterStatus === 'All' || getConsolidatedStatus(ticket.status) === filterStatus;
                return matchesStatus;
            });
            
            root.innerHTML = `
                <header class="bg-[#f2f2f2] p-4 rounded-2xl shadow-lg flex flex-col md:flex-row items-center justify-between mb-8">
                    <div class="flex items-center mb-4 md:mb-0">
                        <div class="flex-shrink-0">
                            <img src="logo_header.png" alt="Company Logo" class="h-10 w-auto mr-4">
                        </div>
                        <h1 class="text-3xl font-bold text-[#00212d] text-center md:text-center w-full">Work Order Dashboard</h1>
                    </div>
                    <div class="flex-shrink-0">
                        ${isLoggedIn ? `
                            <button id="logout-btn" class="bg-red-500 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-200">Logout</button>
                        ` : `
                            <button id="login-btn" class="bg-[#003366] hover:bg-[#00212d] text-[#f2f2f2] font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-200">Login</button>
                        `}
                    </div>
                </header>
                
                ${isLoggedIn ? `
                    <div class="flex justify-end mb-4">
                        <button id="add-ticket-btn" class="bg-[#003366] hover:bg-[#00212d] text-[#f2f2f2] font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-200">
                            + Add Ticket
                        </button>
                    </div>
                ` : ''}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                    <div class="bg-[#f2f2f2] p-6 rounded-2xl shadow-lg flex flex-col items-center">
                        <h2 class="text-xl font-semibold mb-4 text-center text-[#00212d]">Ticket Status</h2>
                        <div id="status-summary" class="grid grid-cols-2 gap-4 w-full">
                            ${predefinedStatuses.map(status => {
                                const count = tickets.filter(t => getConsolidatedStatus(t.status) === status).length;
                                return count > 0 ? `
                                <button class="status-btn p-4 rounded-lg shadow-sm text-sm text-center transition-colors duration-200 hover:opacity-80" data-status="${status}" style="background-color: ${statusColors[status]}; color: white;">
                                    <span class="font-bold text-lg">${count}</span>
                                    <span class="block">${status}</span>
                                </button>
                                ` : '';
                            }).join('')}
                        </div>
                    </div>
                    <div class="bg-[#f2f2f2] p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-semibold mb-4 text-center text-[#00212d]">Calendar View</h2>
                        <div id="calendar-container"></div>
                    </div>
                </div>

                <div class="bg-[#f2f2f2] p-6 rounded-2xl shadow-lg mt-8">
                    <h2 class="text-2xl font-bold mb-6 text-center text-[#003366]">Work Order Details (${filteredTickets.length} of ${tickets.length})</h2>
                    <div class="flex flex-col md:flex-row justify-between mb-4 space-y-4 md:space-y-0">
                        <input type="text" id="search-input" placeholder="Search..." class="bg-white text-[#00212d] p-3 rounded-lg border border-gray-300 focus:outline-none focus:border-[#003366] w-full md:w-1/3">
                        <div class="flex items-center space-x-4">
                            ${filterStatus !== 'All' ? `<span class="text-sm font-medium text-[#4a5568]">Filtering by: <span class="font-bold text-[#003366]">${filterStatus}</span></span>` : ''}
                            <button id="clear-filter-btn" class="bg-white hover:bg-gray-100 text-[#00212d] py-2 px-4 rounded-lg text-sm transition-colors duration-200 border border-gray-300">Clear Filter</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-300">
                            <thead class="bg-[#e6e6e6]">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider">Work Order</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider">Image</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider">Submission Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider">Planned Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider">Responsible</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider">High Risk</th>
                                    ${isLoggedIn ? `<th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider">Actions</th>` : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-[#f2f2f2] divide-y divide-gray-300" id="tickets-table-body">
                                <!-- Tickets will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Re-attach event listeners after rendering
            attachEventListeners();
            renderTicketsTable(filteredTickets);
            renderCalendarView();
        };

        const renderTicketsTable = (filteredTickets) => {
            const tableBody = document.getElementById('tickets-table-body');
            if (!tableBody) return;

            tableBody.innerHTML = filteredTickets.map(ticket => `
                <tr class="hover:bg-gray-100 transition-colors duration-200 cursor-pointer" data-id="${ticket.id}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-[#00212d]">${ticket.workOrder}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-[#00212d]">
                        ${ticket.image ? `<img src="${ticket.image}" alt="Ticket thumbnail" class="h-10 w-10 object-cover rounded-lg">` : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-[#00212d]">${ticket.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-[#00212d]">${getConsolidatedStatus(ticket.status)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-[#00212d]">${ticket.submissionDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-[#00212d]">${ticket.plannedDate || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-[#00212d]">${ticket.responsible || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-[#00212d]">${ticket.highRisk}</td>
                    ${isLoggedIn ? `
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-[#003366] hover:text-[#00212d] transition-colors duration-200 mr-4 edit-btn" data-id="${ticket.id}">Edit</button>
                            <button class="text-red-600 hover:text-red-800 transition-colors duration-200 delete-btn" data-id="${ticket.id}">Delete</button>
                        </td>
                    ` : ''}
                </tr>
            `).join('');
        };

        const renderCalendarView = (date = new Date()) => {
            const calendarContainer = document.getElementById('calendar-container');
            if (!calendarContainer) return;

            const plannedDates = tickets
                .filter(t => t.plannedDate)
                .map(t => ({ date: parseDate(t.plannedDate), status: getConsolidatedStatus(t.status) }));
                
            const getDaysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            const getFirstDayOfMonth = (date) => new Date(date.getFullYear(), date.getMonth(), 1).getDay();

            const daysInMonth = getDaysInMonth(date);
            const firstDay = getFirstDayOfMonth(date);

            let daysHtml = '';
            for (let i = 0; i < firstDay; i++) {
                daysHtml += `<div class="p-2"></div>`;
            }
            for (let i = 1; i <= daysInMonth; i++) {
                const events = plannedDates.filter(e =>
                    e.date &&
                    e.date.getDate() === i &&
                    e.date.getMonth() === date.getMonth() &&
                    e.date.getFullYear() === date.getFullYear()
                );
                
                const eventIndicators = events.map(event => `<span class="w-2 h-2 rounded-full m-[1px]" style="background-color: ${statusColors[event.status]}"></span>`).join('');
                const title = events.length > 0 ? events.map(e => `Status: ${e.status}`).join(', ') : '';
                const bgColor = events.length > 0 ? 'bg-[#cce5d9] hover:bg-[#b8d1c1]' : 'hover:bg-[#e6e6e6]';

                daysHtml += `
                    <div class="p-2 border border-gray-300 rounded-lg text-sm transition-colors duration-200 ${bgColor}" title="${title}">
                        <div class="font-bold text-[#00212d]">${i}</div>
                        <div class="flex flex-wrap mt-1">
                            ${eventIndicators}
                        </div>
                    </div>
                `;
            }

            calendarContainer.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month-btn" class="text-[#00212d] hover:text-[#003366] font-semibold transition-colors duration-200">< Prev</button>
                    <h2 class="text-xl font-semibold text-center text-[#00212d]">${date.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
                    <button id="next-month-btn" class="text-[#00212d] hover:text-[#003366] font-semibold transition-colors duration-200">Next ></button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-[#4a5568] text-sm mb-2">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div class="grid grid-cols-7 gap-1 min-h-[300px]">
                    ${daysHtml}
                </div>
            `;
            
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                const newDate = new Date(date.getFullYear(), date.getMonth() - 1, 1);
                renderCalendarView(newDate);
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                const newDate = new Date(date.getFullYear(), date.getMonth() + 1, 1);
                renderCalendarView(newDate);
            });
        };

        const renderFormModal = (ticket = null) => {
            const modalHtml = `
                <div class="modal-backdrop" id="ticket-modal">
                    <div class="bg-[#f2f2f2] p-8 rounded-2xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-6 text-center text-[#003366]">${ticket ? 'Edit Ticket' : 'Add a New Ticket'}</h2>
                        <form id="ticket-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <input type="hidden" id="ticket-id" value="${ticket ? ticket.id : ''}">
                            <div class="flex flex-col">
                                <label class="text-sm font-medium text-[#00212d] mb-1">Work Order</label>
                                <input type="text" id="workOrder" value="${ticket ? ticket.workOrder : ''}" class="p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]" required>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm font-medium text-[#00212d] mb-1">Description</label>
                                <input type="text" id="description" value="${ticket ? ticket.description : ''}" class="p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]" required>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm font-medium text-[#00212d] mb-1">Submission Date</label>
                                <input type="date" id="submissionDate" value="${ticket ? ticket.submissionDate : ''}" class="p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm font-medium text-[#00212d] mb-1">High Risk</label>
                                <select id="highRisk" class="p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]">
                                    <option value="Yes" ${ticket && ticket.highRisk === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${ticket && ticket.highRisk === 'No' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm font-medium text-[#00212d] mb-1">Status</label>
                                <select id="status" class="p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]" required>
                                    <option value="">Select a Status</option>
                                    ${predefinedStatuses.map(s => `<option value="${s}" ${ticket && ticket.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm font-medium text-[#00212d] mb-1">Planned Date</label>
                                <input type="date" id="plannedDate" value="${ticket ? ticket.plannedDate : ''}" class="p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm font-medium text-[#00212d] mb-1">Responsible</label>
                                <input type="text" id="responsible" value="${ticket ? ticket.responsible : ''}" class="p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]">
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm font-medium text-[#00212d] mb-1">Upload Image</label>
                                <input type="file" id="image-upload" accept="image/*" class="p-2 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]">
                                <div id="image-preview" class="mt-2">
                                    ${ticket && ticket.image ? `
                                        <h4 class="text-sm font-medium text-[#00212d]">Image Preview:</h4>
                                        <img src="${ticket.image}" alt="ticket preview" class="w-24 h-24 object-cover rounded-lg mt-1">
                                    ` : ''}
                                </div>
                            </div>
                            <div class="col-span-2">
                                <label class="text-sm font-medium text-[#00212d] mb-2 block">Comments</label>
                                <div id="comments-list" class="bg-white p-4 rounded-lg border border-gray-300 mb-4 h-32 overflow-y-auto">
                                    ${ticket && ticket.comments && ticket.comments.length > 0 ? `
                                        <ul class="list-disc list-inside space-y-1">
                                            ${ticket.comments.map(c => `
                                                <li class="text-sm text-[#00212d]">
                                                    <span class="font-semibold">${c.date}:</span> ${c.text}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    ` : '<p class="text-sm text-gray-500 italic">No comments yet.</p>'}
                                </div>
                                <div class="flex items-center space-x-2">
                                    <textarea id="new-comment" placeholder="Add a new comment..." class="flex-1 p-2 rounded-lg border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]" rows="2"></textarea>
                                    <button type="button" id="add-comment-btn" class="bg-[#003366] hover:bg-[#00212d] text-[#f2f2f2] font-semibold py-2 px-4 rounded-lg transition-colors duration-200 h-full">Add</button>
                                </div>
                            </div>
                            <div class="col-span-2 flex justify-end space-x-4 mt-4">
                                <button type="button" id="close-modal-btn" class="px-6 py-3 rounded-lg text-[#00212d] border border-gray-300 hover:bg-gray-100 transition-colors duration-200">Cancel</button>
                                <button type="submit" class="px-6 py-3 rounded-lg text-[#f2f2f2] bg-[#003366] hover:bg-[#00212d] font-semibold transition-colors duration-200">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Add event listeners for the modal
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('ticket-form').addEventListener('submit', saveTicket);
            document.getElementById('add-comment-btn').addEventListener('click', addComment);
            document.getElementById('image-upload').addEventListener('change', handleImageUpload);
        };
        
        const renderLoginModal = () => {
            const modalHtml = `
                <div class="modal-backdrop" id="login-modal">
                    <div class="bg-[#f2f2f2] p-8 rounded-2xl shadow-xl max-w-sm w-full text-center">
                        <h2 class="text-2xl font-bold mb-6 text-center text-[#003366]">Login</h2>
                        <form id="login-form">
                            <div class="mb-4">
                                <input type="text" id="login-id" placeholder="ID" class="w-full p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]">
                            </div>
                            <div class="mb-6">
                                <input type="password" id="login-password" placeholder="Password" class="w-full p-3 rounded-lg bg-white border border-gray-300 text-[#00212d] focus:outline-none focus:border-[#003366]">
                            </div>
                            <button type="submit" class="w-full bg-[#003366] hover:bg-[#00212d] text-[#f2f2f2] font-semibold py-3 rounded-lg transition-colors duration-200">Login</button>
                            <p id="login-error-message" class="text-red-500 mt-4 hidden"></p>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Allow clicking outside the modal to close it
            document.getElementById('login-modal').addEventListener('click', (e) => {
                if (e.target.id === 'login-modal') {
                    e.target.remove();
                }
            });
        };
        
        const handleLogin = async (e) => {
            e.preventDefault();
            const id = document.getElementById('login-id').value;
            const password = document.getElementById('login-password').value;
            const errorMessage = document.getElementById('login-error-message');
            
            // Hardcoded credentials
            if (id === 'Equans_Alstom' && password === 'St_Brun0') {
                isLoggedIn = true;
                document.getElementById('login-modal').remove();
                renderDashboard();
            } else {
                errorMessage.textContent = 'Invalid ID or password.';
                errorMessage.classList.remove('hidden');
            }
        };
        
        const handleLogout = () => {
            isLoggedIn = false;
            renderDashboard();
        };

        const renderConfirmationModal = (id) => {
            const modalHtml = `
                <div class="modal-backdrop" id="confirmation-modal">
                    <div class="bg-[#f2f2f2] p-8 rounded-2xl shadow-xl max-w-sm w-full text-center">
                        <p class="text-lg text-[#00212d] mb-6">Are you sure you want to delete this ticket?</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirm-delete-btn" data-id="${id}" class="px-6 py-2 rounded-lg text-white bg-red-600 hover:bg-red-700 transition-colors duration-200 font-semibold">Confirm</button>
                            <button id="cancel-delete-btn" class="px-6 py-2 rounded-lg text-[#00212d] border border-gray-300 hover:bg-gray-100 transition-colors duration-200">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete);
            document.getElementById('cancel-delete-btn').addEventListener('click', cancelDelete);
        };

        const renderDetailsModal = (ticket) => {
            const modalHtml = `
                <div class="modal-backdrop" id="details-modal">
                    <div class="bg-[#f2f2f2] p-8 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-[#003366]">Ticket Details: ${ticket.workOrder}</h2>
                            <button id="close-details-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold leading-none">×</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-[#00212d] mb-6">
                            <div><strong>Description:</strong> ${ticket.description}</div>
                            <div><strong>Status:</strong> ${getConsolidatedStatus(ticket.status)}</div>
                            <div><strong>Submission Date:</strong> ${ticket.submissionDate}</div>
                            <div><strong>Planned Date:</strong> ${ticket.plannedDate || 'N/A'}</div>
                            <div><strong>Responsible:</strong> ${ticket.responsible || 'N/A'}</div>
                            <div><strong>High Risk:</strong> ${ticket.highRisk}</div>
                        </div>
                        ${ticket.image ? `
                            <div class="mt-4">
                                <h3 class="text-xl font-semibold text-[#003366] mb-3">Image</h3>
                                <img src="${ticket.image}" alt="Image for ticket ${ticket.workOrder}" class="w-full h-auto rounded-lg shadow-md max-h-96 object-contain">
                            </div>
                        ` : ''}
                        <div class="mt-4">
                            <h3 class="text-xl font-semibold text-[#003366] mb-3">Comments</h3>
                            ${ticket.comments && ticket.comments.length > 0 ? `
                                <ul class="list-disc list-inside space-y-2 text-[#00212d]">
                                    ${ticket.comments.map(c => `
                                        <li><span class="font-bold text-[#003366]">${c.date}:</span> ${c.text}</li>
                                    `).join('')}
                                </ul>
                            ` : `
                                <p class="text-gray-500 italic">No comments available for this ticket.</p>
                            `}
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('close-details-modal-btn').addEventListener('click', () => {
                document.getElementById('details-modal').remove();
            });
        };

        const attachEventListeners = () => {
            const addBtn = document.getElementById('add-ticket-btn');
            if (addBtn) addBtn.addEventListener('click', () => renderFormModal());
            
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) loginBtn.addEventListener('click', renderLoginModal);
            
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);

            const tableBody = document.getElementById('tickets-table-body');
            if (tableBody) {
                tableBody.addEventListener('click', (e) => {
                    const row = e.target.closest('tr');
                    const id = row.dataset.id;
                    const ticket = tickets.find(t => t.id === id);

                    if (e.target.classList.contains('edit-btn') && isLoggedIn) {
                        e.stopPropagation();
                        renderFormModal(ticket);
                    } else if (e.target.classList.contains('delete-btn') && isLoggedIn) {
                        e.stopPropagation();
                        renderConfirmationModal(id);
                    } else if (ticket) {
                         renderDetailsModal(ticket);
                    }
                });
            }
            
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const status = e.currentTarget.dataset.status;
                    filterStatus = (filterStatus === status) ? 'All' : status;
                    renderDashboard();
                });
            });
            
            document.getElementById('clear-filter-btn')?.addEventListener('click', () => {
                filterStatus = 'All';
                renderDashboard();
            });

            document.getElementById('search-input')?.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = tickets.filter(ticket => 
                    Object.values(ticket).some(value => String(value).toLowerCase().includes(searchTerm))
                );
                renderTicketsTable(filtered);
            });
        };
        
        const closeModal = () => {
            document.getElementById('ticket-modal')?.remove();
        };

        const saveTicket = async (e) => {
            e.preventDefault();
            const id = document.getElementById('ticket-id').value;
            const form = {
                workOrder: document.getElementById('workOrder').value,
                description: document.getElementById('description').value,
                submissionDate: document.getElementById('submissionDate').value,
                status: document.getElementById('status').value,
                plannedDate: document.getElementById('plannedDate').value,
                responsible: document.getElementById('responsible').value,
                highRisk: document.getElementById('highRisk').value,
                image: document.getElementById('image-preview').querySelector('img')?.src || null,
                comments: tickets.find(t => t.id === id)?.comments || []
            };

            const newComments = Array.from(document.querySelectorAll('#comments-list li')).map(li => {
                const parts = li.textContent.split(': ');
                return { date: parts[0], text: parts[1] };
            });
            form.comments = newComments;

            if (!userId) {
                console.error("User not authenticated. Cannot save ticket.");
                return;
            }

            try {
                const consolidatedData = {
                    ...form,
                    status: getConsolidatedStatus(form.status),
                    timestamp: serverTimestamp()
                };
                
                const ticketsCollectionRef = collection(db, 'artifacts', APP_ID, 'users', userId, 'tickets');

                if (id) {
                    const ticketDocRef = doc(ticketsCollectionRef, id);
                    await setDoc(ticketDocRef, consolidatedData, { merge: true });
                } else {
                    await addDoc(ticketsCollectionRef, consolidatedData);
                }
            } catch (error) {
                console.error("Error saving ticket: ", error);
            }
            closeModal();
        };

        const addComment = () => {
            const newCommentInput = document.getElementById('new-comment');
            const commentsList = document.getElementById('comments-list');
            if (newCommentInput.value.trim() !== '' && commentsList) {
                const today = new Date().toISOString().split('T')[0];
                const newCommentHtml = `
                    <li class="text-sm text-[#00212d]">
                        <span class="font-semibold">${today}:</span> ${newCommentInput.value}
                    </li>
                `;
                const commentsUl = commentsList.querySelector('ul') || document.createElement('ul');
                if (!commentsList.querySelector('ul')) {
                    commentsList.innerHTML = '';
                    commentsList.appendChild(commentsUl);
                }
                commentsUl.insertAdjacentHTML('beforeend', newCommentHtml);
                newCommentInput.value = '';
            }
        };

        const handleImageUpload = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const previewDiv = document.getElementById('image-preview');
                    previewDiv.innerHTML = `
                        <h4 class="text-sm font-medium text-[#00212d]">Image Preview:</h4>
                        <img src="${reader.result}" alt="ticket preview" class="w-24 h-24 object-cover rounded-lg mt-1">
                    `;
                };
                reader.readAsDataURL(file);
            }
        };

        const confirmDelete = async (e) => {
            const id = e.target.dataset.id;
            if (!userId || !id) {
                console.error("User not authenticated or no ticket to delete.");
                return;
            }
            try {
                const ticketDocRef = doc(db, 'artifacts', APP_ID, 'users', userId, 'tickets', id);
                await deleteDoc(ticketDocRef);
                document.getElementById('confirmation-modal').remove();
            } catch (error) {
                console.error("Error deleting ticket: ", error);
            }
        };

        const cancelDelete = () => {
            document.getElementById('confirmation-modal').remove();
        };
        
        // --- Initialization Logic ---

        window.onload = () => {
            // Initialize Firebase
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Set up Firebase Auth listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    signInAnonymously(auth).then(() => {
                        console.log("Signed in anonymously");
                    }).catch((error) => {
                        console.error("Anonymous sign-in failed:", error);
                    });
                }
                isAuthReady = true;
                if (userId) {
                    startFirestoreListener();
                }
            });
        };

        // Start Firestore data listener after auth is ready
        const startFirestoreListener = () => {
            const ticketsCollectionRef = collection(db, 'artifacts', APP_ID, 'users', userId, 'tickets');
            onSnapshot(ticketsCollectionRef, (snapshot) => {
                tickets = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderDashboard();
            }, (error) => {
                console.error("Error fetching tickets: ", error);
            });
        };

    </script>
</body>
</html>
