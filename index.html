<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Order Dashboard</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #70bd95; /* Main background color */
        }
        /* Style for the scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e6e6e6;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #b3b3b3;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #8e8e8e;
        }

        /* Basic modal backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body class="antialiased">
    <div id="root" class="min-h-screen p-8 font-sans text-[#00212d]">
        <!-- Dashboard will be rendered here by JavaScript -->
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="hidden modal-backdrop">
        <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-[#003366]">Admin Login</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-id" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="login-id" name="login-id" placeholder="Equans_Alstom" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="login-password" name="login-password" placeholder="St_Brun0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <div class="flex justify-between items-center">
                    <button type="submit" class="bg-[#003366] hover:bg-[#00212d] text-[#f2f2f2] font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-200">Login</button>
                    <button type="button" id="close-login-modal" class="text-gray-500 hover:text-gray-700">Cancel</button>
                </div>
                <div id="login-error-message" class="mt-4 text-red-500 text-center hidden">Invalid credentials.</div>
            </form>
        </div>
    </div>
    
    <!-- Add/Edit Ticket Modal -->
    <div id="ticket-modal" class="hidden modal-backdrop">
        <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-lg">
            <h2 id="ticket-modal-title" class="text-2xl font-bold mb-6 text-center text-[#003366]">Add New Ticket</h2>
            <form id="ticket-form">
                <input type="hidden" id="ticket-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="work-order" class="block text-sm font-medium text-gray-700">Work Order #</label>
                        <input type="text" id="work-order" name="work-order" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="submission-date" class="block text-sm font-medium text-gray-700">Submission Date</label>
                        <input type="date" id="submission-date" name="submission-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="description" name="description" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="status" name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </select>
                    </div>
                    <div>
                        <label for="responsible" class="block text-sm font-medium text-gray-700">Responsible</label>
                        <input type="text" id="responsible" name="responsible" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="planned-date" class="block text-sm font-medium text-gray-700">Planned Date</label>
                        <input type="date" id="planned-date" name="planned-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="high-risk" name="high-risk" class="h-4 w-4 text-[#003366] border-gray-300 rounded focus:ring-[#003366]">
                        <label for="high-risk" class="ml-2 block text-sm font-medium text-gray-700">High Risk</label>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-6">
                    <button type="submit" class="bg-[#003366] hover:bg-[#00212d] text-[#f2f2f2] font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-200">Save</button>
                    <button type="button" id="close-ticket-modal" class="text-gray-500 hover:text-gray-700">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal for Delete -->
    <div id="confirmation-modal" class="hidden modal-backdrop">
        <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm text-center">
            <h2 class="text-xl font-bold mb-4 text-red-600">Confirm Deletion</h2>
            <p class="mb-6 text-gray-700">Are you sure you want to delete this ticket? This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-800 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-200">Delete</button>
                <button id="cancel-delete-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-200">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- IMPORTANT: PLACE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
  apiKey: "AIzaSyAil9c2kq2C9jkPDGwlKtJj8qUd_oXqQzI",
  authDomain: "openticketdashboard.firebaseapp.com",
  projectId: "openticketdashboard",
  storageBucket: "openticketdashboard.firebasestorage.app",
  messagingSenderId: "745663706828",
  appId: "1:745663706828:web:068b44618714aa7a3f3469"
};
        
        // Global state variables
        let app, db, auth;
        let tickets = [];
        let isLoggedIn = false;
        let filterStatus = 'All';
        
        // Hardcoded user ID for the specified database path.
        const adminUserId = '66JF47W8TdfJ4iLbrMk7NL50kb02';

        // Predefined statuses and colors for consistency
        const predefinedStatuses = [
            'Completed',
            'In progress',
            'Scheduled',
            'Waiting for material',
            'Waiting for quote',
            'Waiting on client\'s approval',
            'Waiting H&S review',
            'Waiting for Invoice / PO',
            'Scope clarification needed',
        ];

        const statusColors = {
            'Completed': '#006400',
            'In progress': '#FFA500',
            'Scheduled': '#4169E1',
            'Waiting for material': '#DC143C',
            'Waiting for quote': '#8A2BE2',
            'Waiting on client\'s approval': '#FF69B4',
            'Waiting H&S review': '#00CED1',
            'Waiting for Invoice / PO': '#32CD32',
            'Scope clarification needed': '#696969',
        };

        // Helper function to consolidate statuses for grouping
        const getConsolidatedStatus = (status) => {
            if (status && typeof status === 'string' && status.toLowerCase().startsWith('in progress')) {
                return 'In progress';
            }
            return status;
        };
        
        // Helper function to parse dates
        const parseDate = (dateStr) => {
            if (typeof dateStr !== 'string' || !dateStr || !dateStr.includes('-')) {
                return null;
            }
            const [year, month, day] = dateStr.split('-').map(Number);
            if (isNaN(year) || isNaN(month) || isNaN(day)) {
                return null;
            }
            return new Date(year, month - 1, day);
        };
        
        // Helper function to show modals
        const showModal = (modalId) => {
            document.getElementById(modalId).classList.remove('hidden');
        };

        // Helper function to hide modals
        const hideModal = (modalId) => {
            document.getElementById(modalId).classList.add('hidden');
        };

        // --- UI Rendering Functions ---

        const renderDashboard = () => {
            const root = document.getElementById('root');
            if (!root) return;
            
            const filteredTickets = tickets.filter(ticket => {
                const searchInput = document.getElementById('search-input');
                const searchQuery = searchInput ? searchInput.value.toLowerCase() : '';
                const matchesStatus = filterStatus === 'All' || getConsolidatedStatus(ticket.status) === filterStatus;
                const matchesSearch = !searchQuery || JSON.stringify(ticket).toLowerCase().includes(searchQuery);
                return matchesStatus && matchesSearch;
            });
            
            root.innerHTML = `
                <header class="bg-[#f2f2f2] p-4 rounded-2xl shadow-lg flex flex-col md:flex-row items-center justify-between mb-8">
                    <div class="flex items-center mb-4 md:mb-0">
                        <div class="flex-shrink-0">
                            <img src="https://placehold.co/40x40/003366/f2f2f2?text=EQ" alt="Company Logo" class="h-10 w-auto mr-4">
                        </div>
                        <h1 class="text-3xl font-bold text-[#00212d] text-center md:text-center w-full">Work Order Dashboard</h1>
                    </div>
                    <div class="flex-shrink-0">
                        ${isLoggedIn ? `
                            <button id="logout-btn" class="bg-red-500 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-200">Logout</button>
                        ` : `
                            <button id="login-btn" class="bg-[#003366] hover:bg-[#00212d] text-[#f2f2f2] font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-200">Login</button>
                        `}
                    </div>
                </header>
                
                ${isLoggedIn ? `
                    <div class="flex justify-end mb-4">
                        <button id="add-ticket-btn" class="bg-[#003366] hover:bg-[#00212d] text-[#f2f2f2] font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-200">
                            + Add Ticket
                        </button>
                    </div>
                ` : ''}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                    <div class="bg-[#f2f2f2] p-6 rounded-2xl shadow-lg flex flex-col items-center">
                        <h2 class="text-xl font-semibold mb-4 text-center text-[#00212d]">Ticket Status</h2>
                        <div id="status-summary" class="grid grid-cols-2 gap-4 w-full">
                            ${predefinedStatuses.map(status => {
                                const count = tickets.filter(t => getConsolidatedStatus(t.status) === status).length;
                                return count > 0 ? `
                                <button class="status-btn p-4 rounded-lg shadow-sm text-sm text-center transition-colors duration-200 hover:opacity-80" data-status="${status}" style="background-color: ${statusColors[status]}; color: white;">
                                    <span class="font-bold text-lg">${count}</span>
                                    <span class="block">${status}</span>
                                </button>
                                ` : '';
                            }).join('')}
                        </div>
                    </div>
                    <div class="bg-[#f2f2f2] p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-semibold mb-4 text-center text-[#00212d]">Calendar View</h2>
                        <div id="calendar-container"></div>
                    </div>
                </div>

                <div class="bg-[#f2f2f2] p-6 rounded-2xl shadow-lg mt-8">
                    <h2 class="text-2xl font-bold mb-6 text-center text-[#003366]">Work Order Details (${filteredTickets.length} of ${tickets.length})</h2>
                    <div class="flex flex-col md:flex-row justify-between mb-4 space-y-4 md:space-y-0">
                        <input type="text" id="search-input" placeholder="Search..." class="bg-white text-[#00212d] p-3 rounded-lg border border-gray-300 focus:outline-none focus:border-[#003366] w-full md:w-1/3">
                        <div class="flex items-center space-x-4">
                            ${filterStatus !== 'All' ? `<span class="text-sm font-medium text-[#4a5568]">Filtering by: <span class="font-bold text-[#003366]">${filterStatus}</span></span>` : ''}
                            <button id="clear-filter-btn" class="bg-white hover:bg-gray-100 text-[#00212d] py-2 px-4 rounded-lg text-sm transition-colors duration-200 border border-gray-300">Clear Filter</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-300">
                            <thead class="bg-[#e6e6e6]">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider w-32">Work Order</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider w-24">Image</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider w-64">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider w-40">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider w-32">Submission Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider w-32">Planned Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider w-40">Responsible</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider w-24">High Risk</th>
                                    ${isLoggedIn ? `<th class="px-6 py-3 text-left text-xs font-medium text-[#00212d] uppercase tracking-wider w-32">Actions</th>` : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-[#f2f2f2] divide-y divide-gray-300" id="tickets-table-body">
                                <!-- Tickets will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            renderTicketsTable(filteredTickets);
            renderCalendarView();
        };

        const renderTicketsTable = (filteredTickets) => {
            const tableBody = document.getElementById('tickets-table-body');
            if (!tableBody) return;

            tableBody.innerHTML = filteredTickets.map(ticket => `
                <tr class="hover:bg-gray-100 transition-colors duration-200 cursor-pointer" data-id="${ticket.id}">
                    <td class="px-6 py-4 text-sm text-[#00212d] w-32">${ticket.workOrder}</td>
                    <td class="px-6 py-4 text-sm text-[#00212d] w-24">
                        ${ticket.image ? `<img src="${ticket.image}" alt="Ticket thumbnail" class="h-10 w-10 object-cover rounded-lg">` : ''}
                    </td>
                    <td class="px-6 py-4 text-sm text-[#00212d] w-64 max-w-xs break-words">${ticket.description}</td>
                    <td class="px-6 py-4 text-sm text-[#00212d] w-40">${getConsolidatedStatus(ticket.status)}</td>
                    <td class="px-6 py-4 text-sm text-[#00212d] w-32">${ticket.submissionDate}</td>
                    <td class="px-6 py-4 text-sm text-[#00212d] w-32">${ticket.plannedDate || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-[#00212d] w-40">${ticket.responsible || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-[#00212d] w-24">${ticket.highRisk}</td>
                    ${isLoggedIn ? `
                    <td class="px-6 py-4 text-right text-sm font-medium w-32">
                        <button class="text-[#003366] hover:text-[#00212d] transition-colors duration-200 mr-4 edit-btn" data-id="${ticket.id}">Edit</button>
                        <button class="text-red-600 hover:text-red-800 transition-colors duration-200 delete-btn" data-id="${ticket.id}">Delete</button>
                    </td>
                    ` : ''}
                </tr>
            `).join('');
        };

        const renderCalendarView = (date = new Date()) => {
            const calendarContainer = document.getElementById('calendar-container');
            if (!calendarContainer) return;

            const plannedDates = tickets
                .filter(t => t.plannedDate)
                .map(t => ({ date: parseDate(t.plannedDate), workOrder: t.workOrder, status: t.status }));

            const today = new Date();
            const currentMonth = date.getMonth();
            const currentYear = date.getFullYear();

            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);

            const startDay = firstDayOfMonth.getDay();
            const daysInMonth = lastDayOfMonth.getDate();

            let calendarHTML = `
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month-btn" class="text-[#00212d] p-2 rounded-full hover:bg-gray-200 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h3 class="text-xl font-semibold">${date.toLocaleString('default', { month: 'long', year: 'numeric' })}</h3>
                    <button id="next-month-btn" class="text-[#00212d] p-2 rounded-full hover:bg-gray-200 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
                <div class="grid grid-cols-7 text-center text-sm font-medium text-[#4a5568] mb-2">
                    <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center">
            `;

            for (let i = 0; i < startDay; i++) {
                calendarHTML += `<div class="p-2"></div>`;
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const currentDate = new Date(currentYear, currentMonth, i);
                const isToday = currentDate.toDateString() === today.toDateString();
                const isTicketDay = plannedDates.some(pd => pd.date && pd.date.toDateString() === currentDate.toDateString());
                const ticketForDay = plannedDates.find(pd => pd.date && pd.date.toDateString() === currentDate.toDateString());

                let dayClasses = 'p-2 rounded-lg transition-colors duration-200';
                if (isToday) {
                    dayClasses += ' bg-[#003366] text-white font-bold';
                } else {
                    dayClasses += ' hover:bg-gray-100';
                }

                if (isTicketDay) {
                    dayClasses += ' bg-opacity-75 relative group';
                    calendarHTML += `
                        <div class="${dayClasses}" style="background-color: ${statusColors[getConsolidatedStatus(ticketForDay.status)]}; color: white;">
                            ${i}
                            <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-25 rounded-lg transition-all duration-200"></div>
                            <div class="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 hidden group-hover:block w-32 bg-gray-800 text-white text-xs rounded-md py-1 px-2 z-10 whitespace-nowrap">
                                ${ticketForDay.workOrder}
                            </div>
                        </div>
                    `;
                } else {
                    calendarHTML += `<div class="${dayClasses}">${i}</div>`;
                }
            }

            calendarHTML += `</div>`;
            calendarContainer.innerHTML = calendarHTML;

            // Calendar navigation buttons will be handled by event delegation
        };
        
        // --- Firebase Interaction Functions ---

        // The custom token provided by the environment will handle Firebase authentication.
        // We will not use signInWithEmailAndPassword to avoid the 'auth/operation-not-allowed' error.

        const handleLogin = async (username, password) => {
            // Check against hardcoded credentials
            if (username === 'Equans_Alstom' && password === 'St_Brun0') {
                isLoggedIn = true;
                hideModal('login-modal');
                // Re-render the dashboard to show admin buttons
                renderDashboard();
                return true;
            } else {
                document.getElementById('login-error-message').innerText = "Invalid credentials. Please try again.";
                document.getElementById('login-error-message').classList.remove('hidden');
                return false;
            }
        };

        const handleLogout = () => {
            isLoggedIn = false;
            // Re-render the dashboard to hide admin buttons
            renderDashboard();
        };
        
        const addTicket = async (ticketData) => {
            try {
                if (!isLoggedIn) {
                    // This check is a failsafe; the UI should already prevent this.
                    console.error("User not logged in. Cannot add tickets.");
                    return;
                }
                const appId = firebaseConfig.appId;
                const newTicket = {
                    ...ticketData,
                    highRisk: ticketData.highRisk === 'true',
                    submissionDate: serverTimestamp(),
                };
                // Use the hardcoded adminUserId in the path
                await addDoc(collection(db, 'artifacts', appId, 'users', adminUserId, 'tickets'), newTicket);
                hideModal('ticket-modal');
                console.log("Ticket added successfully!");
            } catch (error) {
                console.error("Error adding ticket:", error);
            }
        };

        const updateTicket = async (ticketId, ticketData) => {
            try {
                if (!isLoggedIn) {
                    console.error("User not logged in. Cannot update tickets.");
                    return;
                }
                const appId = firebaseConfig.appId;
                const updatedTicket = {
                    ...ticketData,
                    highRisk: ticketData.highRisk === 'true',
                };
                // Use the hardcoded adminUserId in the path
                await setDoc(doc(db, 'artifacts', appId, 'users', adminUserId, 'tickets', ticketId), updatedTicket, { merge: true });
                hideModal('ticket-modal');
                console.log("Ticket updated successfully!");
            } catch (error) {
                console.error("Error updating ticket:", error);
            }
        };

        const deleteTicket = async (ticketId) => {
            try {
                if (!isLoggedIn) {
                    console.error("User not logged in. Cannot delete tickets.");
                    return;
                }
                const appId = firebaseConfig.appId;
                // Use the hardcoded adminUserId in the path
                await deleteDoc(doc(db, 'artifacts', appId, 'users', adminUserId, 'tickets', ticketId));
                hideModal('confirmation-modal');
                console.log("Ticket deleted successfully!");
            } catch (error) {
                console.error("Error deleting ticket:", error);
            }
        };

        // --- Event Listeners ---
        const attachEventListeners = () => {
            const root = document.getElementById('root');
            if (!root) return;
            
            root.addEventListener('click', (e) => {
                // Login/Logout button logic
                if (e.target.id === 'login-btn') {
                    showModal('login-modal');
                } else if (e.target.id === 'logout-btn') {
                    handleLogout();
                }

                // Filter button logic
                else if (e.target.closest('.status-btn')) {
                    const status = e.target.closest('.status-btn').dataset.status;
                    filterStatus = status;
                    renderDashboard();
                } else if (e.target.id === 'clear-filter-btn') {
                    filterStatus = 'All';
                    renderDashboard();
                }
                
                // Admin action button logic
                else if (e.target.id === 'add-ticket-btn') {
                    document.getElementById('ticket-modal-title').innerText = "Add New Ticket";
                    document.getElementById('ticket-id').value = "";
                    document.getElementById('ticket-form').reset();
                    showModal('ticket-modal');
                } else if (e.target.classList.contains('edit-btn')) {
                    const ticketId = e.target.dataset.id;
                    const ticketToEdit = tickets.find(t => t.id === ticketId);
                    if (ticketToEdit) {
                        document.getElementById('ticket-modal-title').innerText = "Edit Ticket";
                        document.getElementById('ticket-id').value = ticketId;
                        document.getElementById('work-order').value = ticketToEdit.workOrder || '';
                        document.getElementById('description').value = ticketToEdit.description || '';
                        document.getElementById('status').value = ticketToEdit.status || '';
                        document.getElementById('responsible').value = ticketToEdit.responsible || '';
                        document.getElementById('planned-date').value = ticketToEdit.plannedDate || '';
                        document.getElementById('high-risk').checked = ticketToEdit.highRisk === 'true' || ticketToEdit.highRisk === true;
                        showModal('ticket-modal');
                    }
                } else if (e.target.classList.contains('delete-btn')) {
                    const ticketId = e.target.dataset.id;
                    document.getElementById('confirm-delete-btn').dataset.id = ticketId;
                    showModal('confirmation-modal');
                }

                // Calendar navigation
                else if (e.target.id === 'prev-month-btn' || e.target.closest('#prev-month-btn')) {
                    const currentCalendarDate = new Date(document.querySelector('#calendar-container h3').innerText);
                    const newDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() - 1, 1);
                    renderCalendarView(newDate);
                } else if (e.target.id === 'next-month-btn' || e.target.closest('#next-month-btn')) {
                    const currentCalendarDate = new Date(document.querySelector('#calendar-container h3').innerText);
                    const newDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 1);
                    renderCalendarView(newDate);
                }
            });

            // Search input listener
            document.addEventListener('input', (e) => {
                if (e.target.id === 'search-input') {
                    renderDashboard();
                }
            });

            // Login form submission and close
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = e.target.elements['login-id'].value;
                const password = e.target.elements['login-password'].value;
                await handleLogin(username, password);
            });
            document.getElementById('close-login-modal').addEventListener('click', () => hideModal('login-modal'));

            // Ticket form submission
            document.getElementById('ticket-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const ticketId = document.getElementById('ticket-id').value;
                const ticketData = {
                    workOrder: document.getElementById('work-order').value,
                    description: document.getElementById('description').value,
                    status: document.getElementById('status').value,
                    submissionDate: document.getElementById('submission-date').value,
                    plannedDate: document.getElementById('planned-date').value,
                    responsible: document.getElementById('responsible').value,
                    highRisk: document.getElementById('high-risk').checked ? 'true' : 'false',
                    // Image and other fields would be added here
                };

                if (ticketId) {
                    await updateTicket(ticketId, ticketData);
                } else {
                    await addTicket(ticketData);
                }
            });
            document.getElementById('close-ticket-modal').addEventListener('click', () => hideModal('ticket-modal'));

            // Delete confirmation buttons
            document.getElementById('confirm-delete-btn').addEventListener('click', async (e) => {
                const ticketId = e.target.dataset.id;
                await deleteTicket(ticketId);
            });
            document.getElementById('cancel-delete-btn').addEventListener('click', () => hideModal('confirmation-modal'));

            // Populate status select options
            const statusSelect = document.getElementById('status');
            predefinedStatuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusSelect.appendChild(option);
            });
        };
        
        // --- Initialization Logic ---

        const startFirestoreListener = () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const adminUserId = '66JF47W8TdfJ4iLbrMk7NL50kb02';
            
            const ticketsCollectionRef = collection(db, 'artifacts', appId, 'users', adminUserId, 'tickets');

            onSnapshot(ticketsCollectionRef, (snapshot) => {
                tickets = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // Sort tickets by submission date, newest first
                tickets.sort((a, b) => {
                    const dateA = a.submissionDate?.toDate ? a.submissionDate.toDate() : 0;
                    const dateB = b.submissionDate?.toDate ? b.submissionDate.toDate() : 0;
                    return dateB - dateA;
                });
                renderDashboard();
            }, (error) => {
                console.error("Error fetching tickets: ", error);
            });
        };

        window.onload = async () => {
            try {
                // Initialize Firebase with the hardcoded config
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Use a custom token or anonymous sign-in to authenticate with Firestore.
                // This happens automatically in the background, separate from the UI login.
                const customAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (customAuthToken) {
                    await signInWithCustomToken(auth, customAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Now that Firebase is authenticated, we can start the data listener.
                startFirestoreListener();

                // Attach UI event listeners
                attachEventListeners();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        };
    </script>
</body>
</html>
